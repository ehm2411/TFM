---
title: "PEC3 TFM UOC"
author: "Esteban Hernández Maldonado"
date: "22 de abril de 2021"
output:
  pdf_document:
    toc: yes
    toc_depth: 4
  html_document:
    toc: yes
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# PEC 3.

## 1. Fase exploratoria
### 1.1 Lectura y preparación de los datos

El fichero de datos contiente 145 variables. Muchas de ellas se pueden omitir porque son las respuestas a cada de una de las preguntas de tres cuestionarios diferentes y en este estudio se utilizarán sólo las puntuaciones estandarizadas del cuestionario DMSES completo y el de cada uno de su cuatro apartados.

También se descartarán las variables que son la categorización de otras variables del fichero. Si alguna categorización o agrupación de valores fuera necesaria se creará en su debido momento.

Por otra lado se crearán variables nuevas:

- BMI: la variable continua BMI puede estar más relacionada con la diabetes que no las variables peso y altura (estas dos variables se descartarán una vez se haya calculado el BMI). 
- sobrepeso: la variable categórica sobrepeso (1:Sí, 0:No) se calculará a partir del BMI (BMI>25: sobrepeso)
- obesidad: la variable categórica obesidad (1:Sí, 0:No) se calculará a partir del BMI (BMI>30: obesidad)
- alerta: la variable categórica alerta (1:Sí, 0:No) se calculará a partir de la variable hba1c (hba1c>7%). Se considera que un valor de hba1c > 7% indica que la diabetes no está siendo bien contralado por el paciente.

#### 1.1.1 Lectura y creación de variables derivadas
```{r lectura,warning=FALSE,message=FALSE}
library(MASS)
library(dplyr)
library(ggplot2)
library(mgcv)
library(gnm)
library(GGally)
library(gmodels)
library(Hmisc)
library(caret)
library(ROCR)
library(gridExtra)
library(corrplot)
library(kableExtra)
library(faraway)
library(ggpubr)
library(klaR)  


setwd("C:/Users/ehm24/Documents/master/TFM")

datos.raw <- read.csv("./datos/MontiFinal.csv")

# eliminamos las preguntas de los cuestionarios, categorizaciones de variables y
# otras variables no relevantes para el estudio
datos <- datos.raw[,-c(1,2,15,22,26:84,113:131,137:142,144:145)]

# definimos los factores

# Patient identifier
datos$id.code <- as.factor(datos$id.code)
# Hospital identifier
datos$hospid <- factor(datos$hospid,levels=c(1,2,3,4),
                       labels=c("phupaman","srinakarin","wegaronrat","chula")) 
# Sex
datos$gender <- factor(datos$gender,levels=c(1,2),
                       labels=c("Hombre","Mujer"))                             
# Marital status
datos$mstatus <- factor(datos$mstatus,levels=c(1,2,3,4,5),
                        labels=c("Soltero","´Casado",
                                 "Viudo","Divorciado","Separado"))             
# Education level
datos$edu <- factor(datos$edu,
                    levels=c(1,2,3,4,5,6),
                    labels=c("Sin estudios" , "Primarios", "Secundarios",  
                             "Grado", "Master", "Grado Superior"))             
# Religion
datos$religion <- factor(datos$religion,levels=c(1,2,3,4),
                         labels=c("Budismo", "Islam", "Cristianismo","Otra religión"))                             
# Income
datos$income <- factor(datos$income, levels=c(1,2,3,4,5,6), 
                       labels=c("menos de 4,999 bath", "5,000-9,999  bath", 
                                "10,000-14,999 bath", "15,000-19,999 bath", 
                                "20,000-24,999 bath", "más de 25,000 bath"))
# Family history of T2DM
datos$famhx <- factor(datos$famhx,levels=c(0,1),labels=c("No", "Sí"))           
# Comorbid disease
datos$comob <- factor(datos$comob,levels=c(0,1),labels=c("No", "Sí"))           
# Comorbidity lipidemia
datos$comlip <- factor(datos$comlip,levels=c(0,1),labels=c("No", "Sí"))         
# Comorbidity hypertension
datos$comht <- factor(datos$comht,levels=c(0,1),labels=c("No", "Sí"))           
# Comorbidity coronary heart disease
datos$comchd <- factor(datos$comchd,levels=c(0,1),labels=c("No", "Sí"))          
# Comorbidity kidney disease
datos$comkid <- factor(datos$comkid,levels=c(0,1),labels=c("No", "Sí"))         
# Other comorbidity
datos$comoth <- factor(datos$comoth,levels=c(0,1),labels=c("No", "Sí"))         
# Type of Treatment of DM 
datos$dmrx <- factor(datos$dmrx,
                     levels=c(1,2,3,4),
                     labels=c("Sin medicación","Hipoglicémico oral",
                              "Insulina","Ambos"))   
# Smoking
datos$smk <- factor(datos$smk,levels=c(1,2,3),
                    labels=c("Sí","Exfumador","No"))                            
# Alcohol
datos$alcohol <- factor(datos$alcohol,levels=c(1,2,3),
                        labels=c("Sí","Exbebedor","No"))                        
# Diabetes Complication 
datos$compli <- factor(datos$compli,levels=c(0,1),labels=c("No", "Sí"))         
# Cerebrovascular Accident
datos$cva <- factor(datos$cva,levels=c(0,1),labels=c("No", "Sí"))               
# Cerebral Infraction
datos$cereinfrac <- factor(datos$cereinfrac,levels=c(0,1),labels=c("No", "Sí")) 
# Ischemic Stroke
datos$ishemic <- factor(datos$ishemic,levels=c(0,1),labels=c("No", "Sí"))       
# Stroke, Not specify
datos$stroke <- factor(datos$stroke,levels=c(0,1),labels=c("No", "Sí"))         
# Cerebral Hemorrhage
datos$cerebhem <- factor(datos$cerebhem,levels=c(0,1),labels=c("No", "Sí"))     
# Transient Ischemic Attack
datos$tia <- factor(datos$tia,levels=c(0,1),labels=c("No", "Sí"))               
# Angina pectoris
datos$angia <- factor(datos$angia,levels=c(0,1),labels=c("No", "Sí"))           
# Congestive Heart Failure
datos$chf <- factor(datos$chf,levels=c(0,1),labels=c("No", "Sí"))               
# Myocardial Infraction
datos$mi <- factor(datos$mi,levels=c(0,1),labels=c("No", "Sí"))                 
# Coronary Revascularization
datos$cororevas <- factor(datos$cororevas,levels=c(0,1),labels=c("No", "Sí"))   
# Peripheral Arterial Disease
datos$pad <- factor(datos$pad,levels=c(0,1),labels=c("No", "Sí"))               
# Neuropathy
datos$neuropath <- factor(datos$neuropath,levels=c(0,1),labels=c("No", "Sí"))   
# Renal Insufficiency
datos$renal <- factor(datos$renal,levels=c(0,1),labels=c("No", "Sí"))           
# Diabetes Nephropathy
datos$dn <- factor(datos$dn,levels=c(0,1),labels=c("No", "Sí"))                 
# Diabetes Retinopathy
datos$dr <- factor(datos$dr,levels=c(0,1),labels=c("No", "Sí"))                 
# Other complication
datos$othcomp <- factor(datos$othcomp,levels=c(0,1),labels=c("No", "Sí"))       


# creación de variables derivadas

# alerta: 1-Sí si hba1c > 7% (diabetes no controlada)
datos$alerta <- factor(ifelse(datos$hba1c > 7,1,0),
                       levels=c(0,1),
                       labels=c("No", "Sí"))
# BMI
datos$bmi <- datos$weight/(datos$height/100)**2
# sobrepeso, BMI >25
datos$sobrepeso <- factor(ifelse(datos$bmi > 25,1,0),
                          levels=c(0,1),labels=c("No", "Sí"))
# obesidad, BMI > 30
datos$obesidad <- factor(ifelse(datos$bmi > 30,1,0),
                         levels=c(0,1),labels=c("No", "Sí"))

# transformación a variable tipo date de todas las variables fecha
# estas variables son útiles para poder determinar que datos tienen 
# información actualizada
datos$fecha.hba1c <- as.Date(datos$hba1cdate,"%d/%m/%y")
datos$fecha.ldl <- as.Date(datos$ldldate,"%d/%m/%y")
datos$fecha.hdl <- as.Date(datos$hdldate,"%d/%m/%y")
datos$fecha.trig <- as.Date(datos$trigdate,"%d/%m/%y")
datos$fecha.bp <- as.Date(datos$bpdate,"%d/%m/%y")

# eliminación de variables no necesarias
drop.cols <- c("weight","height","hba1cdate","ldldate","hdldate","trigdate","bpdate")
datos <- datos %>% select(-all_of(drop.cols))
```

#### 1.1.2 Datos faltantes
Se tiene sólo datos faltantes en dos variables tipo fecha (fecha.ldl y fecha.bp) y en sólo dos pacientes.

```{r datos_faltantes}
# datos faltantes
datos[!complete.cases(datos),]
```
#### 1.1.3 Outliers

Las variables continuas son:  
age   
dmdura   
hba1c           
ldl   
hdl   
trig   
sbp   
dbp   
DMSES.Diet   
DMSES.Monitor   
DMSES.Physical   
DMSES.Regimen   
DMSES.Total   
DK.10   


```{r outliers}
flag_outliers <- function(x, na.rm = TRUE, ...) {
  qnt <- quantile(x, probs=c(.25, .75), na.rm = na.rm, ...)
  H <- 1.5 * IQR(x)
  y <- x
  y[x < (qnt[1] - H)] <- NA
  y[x > (qnt[2] + H)] <- NA
  z <-as.factor(as.integer(is.na(y)))
  return(z)
}

datos$age_out <- flag_outliers(datos$age)
datos$dmdura_out <- flag_outliers(datos$dmdura)
datos$hba1c_out <- flag_outliers(datos$hba1c)         
datos$ldl_out <- flag_outliers(datos$ldl)
datos$hdl_out <- flag_outliers(datos$hdl)
datos$trig_out <- flag_outliers(datos$trig)
datos$sbp_out <- flag_outliers(datos$sbp)
datos$dbp_out <- flag_outliers(datos$dbp)
datos$DMSES.Diet_out <- flag_outliers(datos$DMSES.Diet)
datos$DMSES.Monitor_out <- flag_outliers(datos$DMSES.Monitor)
datos$DMSES.Physical_out <- flag_outliers(datos$DMSES.Physical)
datos$DMSES.Regimen_out <- flag_outliers(datos$DMSES.Regimen)
datos$DMSES.Total_out <- flag_outliers(datos$DMSES.Total)
datos$DK.10_out <- flag_outliers(datos$DK.10)
datos$bmi_out <- flag_outliers(datos$bmi)

summary(datos)

# flags para outliers
vars_out <- c("age_out","dmdura_out","hba1c_out","ldl_out","hdl_out","trig_out","sbp_out","dbp_out",
              "DMSES.Diet_out","DMSES.Monitor_out","DMSES.Physical_out","DMSES.Regimen_out",
              "DMSES.Total_out","DK.10_out")

# la variable datos$out valdrá uno si alguna de las variables continuas es outlier, 0 en caso contrario
datos$out <- apply(datos[,vars_out],1,max)


# variables continuas
vars_cont <- c("age","dmdura","hba1c","ldl","hdl","trig","sbp","dbp",
              "DMSES.Diet","DMSES.Monitor","DMSES.Physical","DMSES.Regimen",
              "DMSES.Total","DK.10")

# variables categóricas
vars_cat <- c("id.code","hospid","gender","mstatus","edu","religion","income",
              "famhx","comob","comlip","comht","comchd","comkid","comoth","dmrx",
              "smk","alcohol","compli","cva","cereinfrac","ishemic","stroke","cerebhem",
              "tia","angia","chf","mi","cororevas","pad","neuropath","renal","dn",
              "dr","othcomp","alerta","sobrepeso","obesidad",vars_out,"out")

# otras variables
vars_otras <- c("fecha.hba1c","fecha.ldl","fecha.hdl","fecha.trig","fecha.bp")

# todas las variables
vars <- c(vars_cat,vars_cont,vars_otras)

# pacientes con alguna variable continua outlier
pat_out <- datos %>% filter(out==1)


dim(pat_out)
dim(datos)

attach(datos)


```

La estructura del fichero inicial, ya con todas las variables derivadas creadas es la que sigue:
```{r desc,eval= TRUE}
# descripcion del fichero con el que se trabajará
str(datos)
```

### 1.2 Exploración unidimensional

Una primera vista a las variables de nuestro fichero:
```{r expluni_sum,eval= TRUE}
summary(datos[,-c(1)])
```

Los únicos valores faltantes se dan en las variables fecha.ldl y fecha.bp, un único caso para cada variable. De momento se decide no eliminar los registros.

Analizamos con un poco más de detalle las variables categóricas

```{r expluni_hist,echo= FALSE, eval= TRUE}
bar_hospid       <- ggplot(datos,aes(hospid)) + geom_bar()
bar_gender       <- ggplot(datos,aes(gender)) + geom_bar()      
bar_mstatus      <- ggplot(datos,aes(mstatus)) + geom_bar()
bar_edu          <- ggplot(datos,aes(edu)) + geom_bar()
bar_religion     <- ggplot(datos,aes(religion)) + geom_bar()
bar_income       <- ggplot(datos,aes(income)) + geom_bar()
bar_famhx        <- ggplot(datos,aes(famhx)) + geom_bar()
bar_comob        <- ggplot(datos,aes(comob)) + geom_bar()
bar_comlip       <- ggplot(datos,aes(comlip)) + geom_bar()
bar_comht        <- ggplot(datos,aes(comht)) + geom_bar()
bar_comchd       <- ggplot(datos,aes(comchd)) + geom_bar()
bar_comkid       <- ggplot(datos,aes(comkid)) + geom_bar()
bar_comoth       <- ggplot(datos,aes(comoth)) + geom_bar()
bar_dmrx         <- ggplot(datos,aes(dmrx)) + geom_bar()
bar_smk          <- ggplot(datos,aes(smk)) + geom_bar()
bar_alcohol      <- ggplot(datos,aes(alcohol)) + geom_bar()
bar_compli       <- ggplot(datos,aes(compli)) + geom_bar()
bar_cva          <- ggplot(datos,aes(cva)) + geom_bar()
bar_cereinfrac   <- ggplot(datos,aes(cereinfrac)) + geom_bar()
bar_ishemic      <- ggplot(datos,aes(ishemic)) + geom_bar()
bar_stroke       <- ggplot(datos,aes(stroke)) + geom_bar()
bar_cerebhem     <- ggplot(datos,aes(cerebhem)) + geom_bar()
bar_tia          <- ggplot(datos,aes(tia)) + geom_bar()
bar_angia        <- ggplot(datos,aes(angia)) + geom_bar()
bar_chf          <- ggplot(datos,aes(chf)) + geom_bar()
bar_mi           <- ggplot(datos,aes(mi)) + geom_bar()
bar_cororevas    <- ggplot(datos,aes(cororevas)) + geom_bar()
bar_pad          <- ggplot(datos,aes(pad)) + geom_bar()
bar_neuropath    <- ggplot(datos,aes(neuropath)) + geom_bar()
bar_renal        <- ggplot(datos,aes(renal)) + geom_bar()
bar_dn           <- ggplot(datos,aes(dn)) + geom_bar()
bar_dr           <- ggplot(datos,aes(dr)) + geom_bar()
bar_othcomp      <- ggplot(datos,aes(othcomp)) + geom_bar()
bar_alerta       <- ggplot(datos,aes(alerta)) + geom_bar()
bar_sobrepeso    <- ggplot(datos,aes(sobrepeso)) + geom_bar()
bar_obesidad     <- ggplot(datos,aes(obesidad)) + geom_bar()

#grid.arrange(bar_hospid,bar_gender,bar_mstatus,bar_edu,bar_religion,bar_income,
#             bar_famhx,bar_comob,bar_comlip,bar_comht,bar_comchd,bar_comkid,
#             bar_comoth,bar_dmrx,bar_smk,bar_alcohol,bar_compli,bar_cva,
#             bar_cereinfrac,bar_ishemic,bar_stroke,bar_cerebhem,bar_tia,bar_angia,
#             bar_chf,bar_mi,bar_cororevas,bar_pad,bar_neuropath,bar_renal,bar_dn,
#             bar_dr,bar_othcomp,bar_alerta,bar_sobrepeso,bar_obesidad,ncol=2)

grid.arrange(bar_hospid,bar_gender,bar_mstatus,bar_edu,bar_religion,bar_income,
             bar_famhx,bar_comob,bar_comlip,bar_comht,bar_comchd,bar_comkid,
             ncol=2)

grid.arrange(bar_comoth,bar_dmrx,bar_smk,bar_alcohol,bar_compli,bar_cva,
             bar_cereinfrac,bar_ishemic,bar_stroke,bar_cerebhem,bar_tia,bar_angia,
             ncol=2)

grid.arrange(bar_chf,bar_mi,bar_cororevas,bar_pad,bar_neuropath,bar_renal,bar_dn,
             bar_dr,bar_othcomp,bar_alerta,bar_sobrepeso,bar_obesidad,ncol=2)
```



Analizamos con un poco más de detalle las variables continuas. 

- Boxplot (con outliers)
```{r expluni_boxp,eval= TRUE}
bx_age            <- ggplot(datos,aes(y=age)) + geom_boxplot()
bx_dmdura         <- ggplot(datos,aes(y=dmdura)) + geom_boxplot()  
bx_hba1c          <- ggplot(datos,aes(y=hba1c)) + geom_boxplot()         
bx_ldl            <- ggplot(datos,aes(y=ldl)) + geom_boxplot() 
bx_hdl            <- ggplot(datos,aes(y=hdl)) + geom_boxplot()
bx_trig           <- ggplot(datos,aes(y=trig)) + geom_boxplot()
bx_sbp            <- ggplot(datos,aes(y=sbp)) + geom_boxplot()
bx_dbp            <- ggplot(datos,aes(y=dbp)) + geom_boxplot()
bx_DMSES.Diet     <- ggplot(datos,aes(y=DMSES.Diet)) + geom_boxplot()
bx_DMSES.Monitor  <- ggplot(datos,aes(y=DMSES.Monitor)) + geom_boxplot()
bx_DMSES.Physical <- ggplot(datos,aes(y=DMSES.Physical)) + geom_boxplot()
bx_DMSES.Regimen  <- ggplot(datos,aes(y=DMSES.Regimen)) + geom_boxplot()
bx_DMSES.Total    <- ggplot(datos,aes(y=DMSES.Total)) + geom_boxplot()
bx_DK.10          <- ggplot(datos,aes(y=DK.10)) + geom_boxplot()
bx_bmi            <- ggplot(datos,aes(y=bmi)) + geom_boxplot()

grid.arrange(bx_age,bx_dmdura,bx_hba1c,bx_ldl,bx_hdl,bx_trig,bx_sbp,bx_dbp,
             bx_DMSES.Diet, bx_DMSES.Monitor, bx_DMSES.Physical, bx_DMSES.Regimen,
             bx_DMSES.Total, bx_DK.10, bx_bmi,ncol=4)

```


- Densidades
```{r expluni_den,eval= TRUE}
den_age            <- ggplot(datos,aes(x=age)) + geom_density()
den_dmdura         <- ggplot(datos,aes(x=dmdura)) + geom_density()  
den_hba1c          <- ggplot(datos,aes(x=hba1c)) + geom_density()         
den_ldl            <- ggplot(datos,aes(x=ldl)) + geom_density() 
den_hdl            <- ggplot(datos,aes(x=hdl)) + geom_density()
den_trig           <- ggplot(datos,aes(x=trig)) + geom_density()
den_sbp            <- ggplot(datos,aes(x=sbp)) + geom_density()
den_dbp            <- ggplot(datos,aes(x=dbp)) + geom_density()
den_DMSES.Diet     <- ggplot(datos,aes(x=DMSES.Diet)) + geom_density()
den_DMSES.Monitor  <- ggplot(datos,aes(x=DMSES.Monitor)) + geom_density()
den_DMSES.Physical <- ggplot(datos,aes(x=DMSES.Physical)) + geom_density()
den_DMSES.Regimen  <- ggplot(datos,aes(x=DMSES.Regimen)) + geom_density()
den_DMSES.Total    <- ggplot(datos,aes(x=DMSES.Total)) + geom_density()
den_DK.10          <- ggplot(datos,aes(x=DK.10)) + geom_density()
den_bmi            <- ggplot(datos,aes(x=bmi)) + geom_density()

grid.arrange(den_age,den_dmdura,den_hba1c,den_ldl,den_hdl,den_trig,den_sbp,den_dbp,
             den_DMSES.Diet, den_DMSES.Monitor, den_DMSES.Physical, den_DMSES.Regimen,
             den_DMSES.Total, den_DK.10, den_bmi,ncol=4)
```

- Normalidad

Ningun predictor sigue una distribución normal según el test de normalidad de Shapiro y según el QQ plot tenemos normalidad en edad, hdl, sbp, dbp, DMSES.Total y DK.10.


```{r expluni_norm,eval=TRUE}

shapiro.test(datos$age)
shapiro.test(datos$dmdura)
shapiro.test(datos$hba1c)
shapiro.test(datos$ldl)
shapiro.test(datos$hdl)
shapiro.test(datos$trig)
shapiro.test(datos$sbp)
shapiro.test(datos$dbp)
shapiro.test(datos$DMSES.Diet)
shapiro.test(datos$DMSES.Monitor)
shapiro.test(datos$DMSES.Physical)
shapiro.test(datos$DMSES.Regimen)
shapiro.test(datos$DMSES.Total)
shapiro.test(datos$DK.10)
shapiro.test(datos$bmi)

#ggqqplot(datos[,vars_cont],combine = TRUE,facet.by=c(5,3))

qq_age            <- ggqqplot(datos$age)
qq_dmdura         <- ggqqplot(datos$dmdura)
qq_hba1c          <- ggqqplot(datos$hba1c)
qq_ldl            <- ggqqplot(datos$ldl)
qq_hdl            <- ggqqplot(datos$hdl)
qq_trig           <- ggqqplot(datos$trig)
qq_sbp            <- ggqqplot(datos$sbp)
qq_dbp            <- ggqqplot(datos$dbp)
qq_DMSES.Diet     <- ggqqplot(datos$DMSES.Diet)
qq_DMSES.Monitor  <- ggqqplot(datos$DMSES.Monitor)
qq_DMSES.Physical <- ggqqplot(datos$DMSES.Physical)
qq_DMSES.Regimen  <- ggqqplot(datos$DMSES.Regimen)
qq_DMSES.Total    <- ggqqplot(datos$DMSES.Total)
qq_DK.10          <- ggqqplot(datos$DK.10)
qq_bmi            <- ggqqplot(datos$bmi)

#Arrange all the plots onto one page

#plot_grid(qq_age, qq_dmdura, qq_hba1c, qq_ldl, qq_hdl, qq_trig,
#         qq_sbp, qq_dbp, qq_DMSES.Diet, qq_DMSES.Monitor,
#         qq_DMSES.Physical, qq_DMSES.Regimen, qq_DMSES.Total,
#         qq_DK.10, qq_bmi, nrow=5,ncol=3)

#grid.arrange(qq_age, qq_dmdura, qq_hba1c, qq_ldl, qq_hdl, qq_trig,
#             qq_sbp, qq_dbp, qq_DMSES.Diet, qq_DMSES.Monitor,
#             qq_DMSES.Physical, qq_DMSES.Regimen, qq_DMSES.Total,
#             qq_DK.10, qq_bmi, ncol=2)


grid.arrange(qq_age, qq_dmdura, qq_hba1c, qq_ldl, qq_hdl, qq_trig, ncol=3)
grid.arrange(qq_sbp, qq_dbp, qq_DMSES.Diet, qq_DMSES.Monitor, 
             qq_DMSES.Physical, qq_DMSES.Regimen, ncol = 3)

grid.arrange(qq_DMSES.Total,qq_DK.10, qq_bmi, ncol=3)

```


## 1.3  Exploración multidimensional

Los niveles de correlación entre las puntuaciones DMSES y el resto de variables continuas son bajos a excepción de la variable hba1c. La mayor correlación entre hba1c y las puntuaciones DMSES se da con el factor dieta. Se detecta que las diferentes puntuaciones del cuestionario DMSES estan fuertemente relacionas, por lo que se puede considerar tomar sólo una para el análisis. La puntuación total y la de la parte de la dieta son las mejoras candidatas debido a que tienen una correlación más alta con hba1c.

```{r explmulti0,eval= TRUE,cache=TRUE}
dim(datos[,vars_cont])
str(datos[,vars_cont])
M <- cor(datos[,c(vars_cont)])
knitr::kable(round(M,2))

corrplot(M,method="circle")

# vamos a ordenar las correlaciones
flattenCorrMatrix <- function(cormat) {
  ut <- upper.tri(cormat)
  dd <- data.frame(
                   row = rownames(cormat)[row(cormat)[ut]],
                   column = rownames(cormat)[col(cormat)[ut]],
                   cor  =(cormat)[ut]
                   )
  dd <- dd[order(abs(dd$cor), decreasing = T),]
  dd$cor <- round(dd$cor, 3)
  dd
}

flattenCorrMatrix(M)  


cor(hba1c,DMSES.Diet)
cor(hba1c,DMSES.Physical)
cor(hba1c,DMSES.Monitor)
cor(hba1c,DMSES.Regimen)
cor(hba1c,DMSES.Total)


```

Podemos ver que las diferentes puntuaciones del cuestionario DMSES (total o de alguna de sus partes) están muy relacionadas. De entre todas las puntuaciones, la del factor dieta es la que mayor correlación tienen con la hba1c, por lo que parece razonable centrarse en el uso de sólo esa puntuación para buscar una relación con la hba1c y descartar el resto de puntuaciones del cuestionario DMSES del análisis. 


Vemos en que medida están relacionadas las puntuaciones del cuestiorio DMSES entre sí.

```{r explmulti1,eval= TRUE,cache=TRUE}
# demostracion DMSES total es la suma de los 4 subscores
max(DMSES.Total - (DMSES.Diet + DMSES.Monitor + DMSES.Physical + DMSES.Regimen))

# relación entre los diferentes subscores
ggpairs(datos[,c("DMSES.Diet","DMSES.Monitor","DMSES.Physical","DMSES.Regimen","DMSES.Total")])
```


Al querer buscar las relaciones entre las puntuaciones del cuestionario DMSES (la puntuación total y la de las partes 'dieta', 'monitor', 'régimen' y 'estado físico') y el nivel de hba1c se observa que no hay una relación lineal a priori. Se valorará hacer transformaciones adecuadas para comprobar si se puede hallar una relación.

```{r explmulti2,eval= TRUE,cache=TRUE}
par(mfrow=c(2,3))
pairs(~ hba1c + DMSES.Diet ,data=datos)
pairs(~ hba1c + DMSES.Monitor,data=datos)
pairs(~ hba1c + DMSES.Physical,data=datos)
pairs(~ hba1c + DMSES.Regimen,data=datos)
pairs(~ hba1c + DMSES.Total,data=datos)
par(mfrow=c(1,1))
```


Tampoco se detecta una relación clara entre las puntuaciones del cuestionario DMSES y la variable categórica 'alerta'.

```{r explmulti3,eval= TRUE,cache=TRUE}
pairs(~ alerta + DMSES.Diet ,data=datos)
pairs(~ alerta + DMSES.Monitor,data=datos)
pairs(~ alerta + DMSES.Physical,data=datos)
pairs(~ alerta + DMSES.Regimen,data=datos)
pairs(~ alerta + DMSES.Total,data=datos)
```


Análisis multivariante de las variables discretas

Las variables discretas con poca variabilidad no se toman en cuenta (cva, cereinfrac, ishemic, stroke, cerebhem,tia, angia, chf, cororevas, pad, neuropath )

```{r explmulti4,eval= TRUE,cache=TRUE}
chisq.test(datos$alerta,datos$hospid)
chisq.test(datos$alerta,datos$gender)
chisq.test(datos$alerta,datos$mstatus)
chisq.test(datos$alerta,datos$edu)
chisq.test(datos$alerta,datos$religion)
chisq.test(datos$alerta,datos$income)
chisq.test(datos$alerta,datos$famhx)
chisq.test(datos$alerta,datos$comob)
chisq.test(datos$alerta,datos$comlip)
chisq.test(datos$alerta,datos$comht)
chisq.test(datos$alerta,datos$comchd)
chisq.test(datos$alerta,datos$comkid)
chisq.test(datos$alerta,datos$comoth)
chisq.test(datos$alerta,datos$dmrx)
chisq.test(datos$alerta,datos$smk)
chisq.test(datos$alerta,datos$alcohol)
chisq.test(datos$alerta,datos$compli)
chisq.test(datos$alerta,datos$mi)
chisq.test(datos$alerta,datos$renal)
chisq.test(datos$alerta,datos$dn)
chisq.test(datos$alerta,datos$dr)
chisq.test(datos$alerta,datos$sobrepeso)
chisq.test(datos$alerta,datos$obesidad)


# caso gráfico

chisq <- chisq.test(datos$gender,datos$income)
# Contibution in percentage (%)
contrib <- 100*chisq$residuals^2/chisq$statistic
# Visualize the contribution
corrplot(contrib, is.cor = FALSE)


chisq <- chisq.test(datos$gender,datos$alerta)
# Contibution in percentage (%)
contrib <- 100*chisq$residuals^2/chisq$statistic
# Visualize the contribution
corrplot(contrib, is.cor = FALSE)

chisq <- chisq.test(datos$income,datos$alerta)
# Contibution in percentage (%)
contrib <- 100*chisq$residuals^2/chisq$statistic
# Visualize the contribution
corrplot(contrib, is.cor = FALSE)

```



## 2 Regresión lineal

El objetivo de este apartado será comprobar si la puntuación del test DMSES (total o de alguno de sus apartados) puede predecir el valor de la variable 'hba1c'. 

```{r lm1,eval= TRUE,cache=TRUE}
par(mfrow=c(2,2))
mod <- lm(hba1c ~ DMSES.Total + DK.10 + age + renal + ldl + bmi,data=datos)
(smod <- summary(mod))
plot(mod)
vif(mod)

# eliminamos DK.10
mod <- lm(hba1c ~ DMSES.Total +         age + renal + ldl + bmi,data=datos)
(smod <- summary(mod))
plot(mod)
vif(mod)

# eliminamos BMI
mod <- lm(hba1c ~ DMSES.Total +         age + renal + ldl      ,data=datos)
(smod <- summary(mod))
plot(mod)
vif(mod)

par(mfrow=c(1,1))
```

No se consigue tener un R2 elevado ni corregir la no normalidad de los residuos. Aplicamos logaritmos a 'hba1c' (variable estrictamente positiva) y se mejora un poco la situación en cuanto a normalidad pero el R2 sigue sin subir.  Búsqueda de outliers pendiente.

```{r lm2,eval= TRUE,cache=TRUE}
par(mfrow=c(2,2))
mod <- lm(log(hba1c) ~ DMSES.Total +         age + renal + ldl      ,data=datos)
(smod <- summary(mod))
plot(mod)
vif(mod)
par(mfrow=c(1,1))
```

```{r lm3,eval= TRUE,cache=TRUE}

datos$dmrx1 <- as.factor(ifelse(datos$dmrx=="Sin medicación",1,0))
datos$dmrx2 <- as.factor(ifelse(datos$dmrx=="Hipoglicémico oral",1,0))
datos$dmrx3 <- as.factor(ifelse(datos$dmrx=="Insulina",1,0))

table(datos$obesidad)


datos[1:10,c("dmrx","dmrx1","dmrx2","dmrx3")]

var.cat.inf   <- c("alerta","obesidad","sobrepeso","gender","renal","dmrx1","dmrx2","dmrx3","dn","dr")
var.cont.norm <- c("age", "hdl", "sbp","dbp","DMSES.Total","DK.10")
var.interes   <- c(var.cat.inf,var.cont.norm)
var.interes
datos1 <- datos[,var.interes]
dim(datos1)

# Fit the full model 
#full.model <- lm(alerta ~., data = datos1)
#summary(full.model)
# Stepwise regression model
#step.model <- stepAIC(full.model, direction = "both", trace = FALSE)
#summary(step.model)

require(leaps)
b <- regsubsets(alerta~.,data=datos1,nvmax = 15)
rs <- summary(b)
rs$which

length(rs$rss)
length(2:16)
rs$rss

AIC <- 50*log(rs$rss/50) + (2:16)*2
dim(AIC)
plot(AIC ~ I(1:15), ylab="AIC", xlab="Number of Predictors")

plot(2:16,rs$adjr2,xlab="No. of Parameters",ylab="Adjusted R-square")
which.max(rs$adjr2)
```
## 3 Regresión logística

El objetivo de este apartado será comprobar si la puntuación del test DMSES (total o de alguno de sus apartados) puede ayudar a discriminar entre pacientes que controlan la diabetes y los que no.

### 3.1 Preparación de los ficheros para 'train' y 'test'

```{r split,eval= TRUE,cache=TRUE}
# cálculo del numero de registros para el training 
# según la proporción de registros dedicado al training
pct.train <- 0.90 

n <- nrow(datos)
n.train <- floor(n*pct.train)

set.seed(123)
ind.training <- sample(1:n,n.train)
length(ind.training)

datos.train <- datos[ind.training,]
datos.test <- datos[-ind.training,]

dim(datos.train)
dim(datos.test)

```

### 3.2 Modelo DMSES subscore Diet

```{r log_diet,eval= TRUE,cache=TRUE}
logdiet <- glm(alerta ~ DMSES.Diet, data = datos.train, family = "binomial")
summary(logdiet)

predicciones <- predict(logdiet,newdata=datos.test[,-c(1)],type='response')
predicciones.categ <- ifelse(predicciones > 0.5,1,0)
predicciones.categ <- factor(predicciones.categ,levels=c(0,1),labels=c("No","Sí"))

# Confusion matrix
confusionMatrix(data=predicciones.categ, reference=datos.test$alerta)

# ROC and AUC
pr <- prediction(predicciones, datos.test$alerta)
# TPR = sensitivity, FPR=specificity
prf <- performance(pr, measure = "tpr", x.measure = "fpr")
plot(prf)

auc <- performance(pr, measure = "auc")
(auc <- auc@y.values[[1]])

#
#
# hay mejora si añadimos algunos predictores?

logdiet <- glm(alerta ~ DMSES.Diet + bmi + dmdura + age, data = datos.train, family = "binomial")
summary(logdiet)

predicciones <- predict(logdiet,newdata=datos.test[,-c(1)],type='response')
predicciones.categ <- ifelse(predicciones > 0.5,1,0)
predicciones.categ <- factor(predicciones.categ,levels=c(0,1),labels=c("No","Sí"))

# Confusion matrix
confusionMatrix(data=predicciones.categ, reference=datos.test$alerta)

# ROC and AUC
pr <- prediction(predicciones, datos.test$alerta)
# TPR = sensitivity, FPR=specificity
prf <- performance(pr, measure = "tpr", x.measure = "fpr")
plot(prf)

auc <- performance(pr, measure = "auc")
(auc <- auc@y.values[[1]])


```

### 3.3 Modelo DMSES subscore Monitor

```{r log_monitor,eval= TRUE,cache=TRUE}
logmonitor <- glm(alerta ~ DMSES.Monitor, data = datos.train, family = "binomial")
summary(logmonitor)

predicciones <- predict(logmonitor,newdata=datos.test[,-c(1)],type='response')
predicciones.categ <- ifelse(predicciones > 0.5,1,0)
predicciones.categ <- factor(predicciones.categ,levels=c(0,1),labels=c("No","Sí"))

# Confusion matrix
confusionMatrix(data=predicciones.categ, reference=datos.test$alerta)

# ROC and AUC
pr <- prediction(predicciones, datos.test$alerta)
# TPR = sensitivity, FPR=specificity
prf <- performance(pr, measure = "tpr", x.measure = "fpr")
plot(prf)

auc <- performance(pr, measure = "auc")
(auc <- auc@y.values[[1]])

```

### 3.4 Modelo DMSES subscore Regimen

```{r log_regimen,eval= TRUE,cache=TRUE}
logregimen <- glm(alerta ~ DMSES.Regimen, data = datos.train, family = "binomial")
summary(logregimen)

predicciones <- predict(logregimen,newdata=datos.test[,-c(1)],type='response')
predicciones.categ <- ifelse(predicciones > 0.5,1,0)
predicciones.categ <- factor(predicciones.categ,levels=c(0,1),labels=c("No","Sí"))

# Confusion matrix
confusionMatrix(data=predicciones.categ, reference=datos.test$alerta)

# ROC and AUC
pr <- prediction(predicciones, datos.test$alerta)
# TPR = sensitivity, FPR=specificity
prf <- performance(pr, measure = "tpr", x.measure = "fpr")
plot(prf)

auc <- performance(pr, measure = "auc")
(auc <- auc@y.values[[1]])

```

### 3.5 Modelo DMSES subscore Physical

```{r log_physical,eval= TRUE,cache=TRUE}
logphysical <- glm(alerta ~ DMSES.Physical, data = datos.train, family = "binomial")
summary(logphysical)

predicciones <- predict(logphysical,newdata=datos.test[,-c(1)],type='response')
predicciones.categ <- ifelse(predicciones > 0.5,1,0)
predicciones.categ <- factor(predicciones.categ,levels=c(0,1),labels=c("No","Sí"))

# Confusion matrix
confusionMatrix(data=predicciones.categ, reference=datos.test$alerta)

# ROC and AUC
pr <- prediction(predicciones, datos.test$alerta)
# TPR = sensitivity, FPR=specificity
prf <- performance(pr, measure = "tpr", x.measure = "fpr")
plot(prf)

auc <- performance(pr, measure = "auc")
(auc <- auc@y.values[[1]])

```



## 4. Análisis multivariante de datos
### 4.1 Análisis de componentes principales

```{r pca_1, eval=TRUE,cache=TRUE}
pca <- prcomp(datos[,vars_cont],scale. = TRUE)
summary(pca)
plot(pca)

pca$rotation[,1:2]


al <- as.numeric(datos$alerta)
MASS::eqscplot(pca$x[,1], pca$x[,2], pch=c(3,21)[al],col=c("blue","red")[al],
         bg="lightblue",xlab="PC1",ylab="PC2")
abline(h=0,v=0,lty=4,col="gray")
legend("topright",pch=c(3,21),col=c("blue","red"), cex=0.8,legend=c("No","Si"))
title(main="Diabetes mas controlada",line=1)

summary(pca)$importance[ ,1:14]


library(factoextra)
fviz_eig(pca)

fviz_pca_var(pca,col.var = "contrib", 
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE )


``` 

El analísis gráfico de componentes principales muestra la contribución de las variables en las dos primeras componentes principales.  

### 4.2 Análisis de conglomerados

```{r clu_1, eval=TRUE, warning= FALSE ,cache=TRUE}
library(cluster)

# Fijamos la semilla aleatoria
set.seed(123)

df <- scale(datos[,vars_cont])

res.dist <- get_dist(df, method = "euclidean")
head(round(as.matrix(res.dist), 2))[, 1:5]

# Visualize the dissimilarity matrix
fviz_dist(res.dist, lab_size = 5)

# Compute hierarchical clustering
res.hc <- hclust(res.dist, method = "ward.D2")

# Visualize
plot(res.hc, cex = 0.5)

# Enhanced k-means clustering
res.km <- eclust(df, "kmeans", nstart = 25, k.max=12)

# Gap statistic plot
fviz_gap_stat(res.km$gap_stat)

# Silhouette plot
fviz_silhouette(res.km)

# Optimal number of clusters using gap statistics
res.km$nbclust
```

```{r clu_2, warning= FALSE, eval = FALSE ,cache=TRUE}

# Enhanced k-means clustering (forzando 11 conglomerados)
res.km11 <- eclust(df, FUNcluster = "kmeans",  nstart = 25, k = 11)

# Gap statistic plot
fviz_gap_stat(res.km11$gap_stat)

# Silhouette plot
fviz_silhouette(res.km11)

``` 

```{r clu_3, eval=TRUE, warning= FALSE ,cache=TRUE}
library(cluster)

# Fijamos la semilla aleatoria
set.seed(123)

df <- scale(datos[,c("hba1c","DMSES.Diet","age")])

res.dist <- get_dist(df, method = "euclidean")
head(round(as.matrix(res.dist), 2))[, 1:5]

# Visualize the dissimilarity matrix
fviz_dist(res.dist, lab_size = 5)

# Compute hierarchical clustering
res.hc <- hclust(res.dist, method = "ward.D2")

# Visualize
plot(res.hc, cex = 0.5)

# Enhanced k-means clustering
res.km <- eclust(df, "kmeans", nstart = 25, k.max=12)

# Gap statistic plot
fviz_gap_stat(res.km$gap_stat)

# Silhouette plot
fviz_silhouette(res.km)

# Optimal number of clusters using gap statistics
res.km$nbclust
```



### 4.3 Análisis discriminante

```{r discr_1, eval=TRUE, warning= FALSE ,cache=TRUE}
# Alerta vs Diet
fit.cv <- lda(alerta ~ DMSES.Diet, data=datos, CV=TRUE)
# Assess the accuracy of the prediction
# percent correct for each category of G
ct <- table(datos$alerta, fit.cv$class)
diag(prop.table(ct, 1))
prop.table(ct, 1)

# total percent correct
sum(diag(prop.table(ct)))

# Alerta vs Diet + age
fit.cv <- lda(alerta ~ DMSES.Diet + age, data=datos, CV=TRUE)
# Assess the accuracy of the prediction
# percent correct for each category of G
ct <- table(datos$alerta, fit.cv$class)
diag(prop.table(ct, 1))
prop.table(ct, 1)

# total percent correct
sum(diag(prop.table(ct)))

partimat(alerta ~ DMSES.Diet + age, data=datos, method="lda")

# Alerta vs otras variables
fit.cv <- lda(alerta ~ DMSES.Diet + age + ldl + hdl + trig + bmi, data=datos, CV=TRUE)
summary(fit.cv)
# Assess the accuracy of the prediction
# percent correct for each category of G
ct <- table(datos$alerta, fit.cv$class)
diag(prop.table(ct, 1))
prop.table(ct, 1)

# total percent correct
sum(diag(prop.table(ct)))
prop.table(ct)

# Analisis discriminante cuadrático
datos.qda <- qda(alerta ~ DMSES.Diet + age, data=datos)
summary(datos.qda)
clq <- predict(datos.qda, datos[,c("DMSES.Diet","age")])$class
ct <- table(datos$alerta, clq)
prop.table(ct)

```


